###############################################################################
# FILE: DM_mappings.ttl
# DESC: Stardog SMS Template file for mapping DM to graph.
# REQ :
# SRC :
# IN  : CSV converted from DM.XPT. First row only
# OUT :
# NOTE: stardog-admin virtual import CTDasRDF DM_mappings.TTL DM_subset.csv
#  Export to TTL: stardog data export --format TURTLE CTDasRDF C:/temp/test.ttl
#   - Birthdate and Deathdate are of the Lifespan interval.
#   - StudyParticipationBegin = date of informed consent: AO email 2071-02-16
# TODO:
###############################################################################

@prefix cd01p: <https://raw.githubusercontent.com/phuse-org/CTDasRDF/master/data/rdf/cdiscpilot01-protocol.ttl#> .
@prefix cdiscpilot01: <https://raw.githubusercontent.com/phuse-org/CTDasRDF/master/data/rdf/cdiscpilot01.ttl#> .
@prefix code: <https://raw.githubusercontent.com/phuse-org/CTDasRDF/master/data/rdf/code.ttl#> .
@prefix custom: <https://raw.githubusercontent.com/phuse-org/CTDasRDF/master/data/rdf/custom#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix sdtmterm: <http://rdf.cdisc.org/sdtmterm#> .
@prefix skos: <http://www.w3.org/2004/02/skos/core#> .
@prefix study: <https://raw.githubusercontent.com/phuse-org/CTDasRDF/master/data/rdf/study.ttl#> .
@prefix time: <http://www.w3.org/2006/time#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .

# -----------------------------------------------------------------------------
# Study Partipants
cd01p:Study_{studyid}
  study:hasStudyParticipant cdiscpilot01:Person_{usubjid}
.

# -----------------------------------------------------------------------------
# Person_
# TODO: CumulativeDrugAdministration_{usubjid}: Sets up the parent triples
#         for those to be built from EX domain.
# ORIGINAL
# -----------------------------------------------------------------------------
cdiscpilot01:Person_{usubjid}
  a study:EnrolledSubject;
  skos:preflabel                      "Person {usubjid}"^^xsd:string ;
  study:actualArm                     cd01p:Arm{actarmcd} ;
  study:deathFlag                     "{dthfl}"^^xsd:string ;
  study:hasLifespan                   cdiscpilot01:Interval_{lifeSpan_im_en};
  study:hasReferenceInterval          cdiscpilot01:Interval_{refInt_im_en} ;
  study:hasSite                       cd01p:Site_{siteid} ;
  study:hasStudyParticipationInterval cdiscpilot01:Interval_{studyPartInt_im_en} ;
  study:hasSubjectID                  cdiscpilot01:SubjectIdentifier_{subjid} ;
  study:hasUniqueSubjectID            cdiscpilot01:UniqueSubjectIdentifier_{usubjid} ;
  study:participatesIn                cdiscpilot01:DemographicDataCollection_{usubjid};
  study:participatesIn                cdiscpilot01:CumulativeDrugAdministration_{cumuDrugAdmin_im_en} ;
  study:participatesIn                cdiscpilot01:InformedConsentAdult_{usubjid} ;
  study:participatesIn                cdiscpilot01:RandomizationBAL3_{usubjid} ;
.

  # Lifespan ----
  #  concat of encoded birthdate and rficdtc dates [this is line 33]
  cdiscpilot01:Interval_{lifeSpan_im_en}
    a study:Lifespan ;
    rdfs:label        "Interval {lifeSpan_im}"^^xsd:string ;
    time:hasBeginning cdiscpilot01:Date_{brthdate_en} ;
    time:hasEnd       cdiscpilot01:Date_{dthdtc_en}
  .

    # Lifespan Dates
    #  a) birthdate
    cdiscpilot01:Date_{brthdate_en}
      rdf:type                  study:Birthdate ;
      rdfs:label                "{brthdate}"^^xsd:string ;
      study:dateTimeInXSDString "{brthdate}"^^xsd:string
    .
    # b) deathdate
    cdiscpilot01:Date_{dthdtc_en}
      rdf:type study:Deathdate ;
      rdfs:label "{dthdtc}"^^xsd:string ;
      study:dateTimeInXSDString "{dthdtc}"^^xsd:string
    .

  # ReferenceInterval ----
  cdiscpilot01:Interval_{refInt_im_en}
    a study:ReferenceInterval ;
    rdfs:label "Interval {refInt_im}"^^xsd:string ;
    time:hasBeginning cdiscpilot01:Date_{rfstdtc_en} ;
    time:hasEnd cdiscpilot01:Date_{rfendtc_en}
  .
    # ReferenceInterval Dates
    #  Assign date type (begin)
    cdiscpilot01:Date_{rfstdtc_en}
      rdf:type study:ReferenceBegin ;
      rdfs:label "{rfstdtc}"^^xsd:string ;
      study:dateTimeInXSDString "{rfstdtc}"^^xsd:string
    .
    #  Assign date type (end)
    cdiscpilot01:Date_{rfendtc_en}
      rdf:type study:ReferenceEnd ;
      rdfs:label "{rfendtc}"^^xsd:string ;
      study:dateTimeInXSDString "{rfendtc}"^^xsd:string
    .

  # StudyParticipationInterval
  cdiscpilot01:Interval_{studyPartInt_im_en}
    rdf:type study:StudyParticipationInterval ;
    rdfs:label "Interval {studyPartInt_im}"^^xsd:string ;
    time:hasBeginning cdiscpilot01:Date_{dmdtc_en} ;
    time:hasEnd cdiscpilot01:Date_{rfpendtc_im_en}
  .
    # StudyParticipationInterval Dates
    #  a) Begin
    cdiscpilot01:Date_{dmdtc_en}
      rdf:type study:StudyParticipationBegin ;
      rdfs:label "{dmdtc}"^^xsd:string ;
      study:dateTimeInXSDString "{dmdtc}"^^xsd:string
    .
    #  b) End
    cdiscpilot01:Date_{rfpendtc_im_en}
      rdf:type study:StudyParticipationEnd ;
      rdfs:label "{rfpendtc}"^^xsd:string ;
      study:dateTimeInXSDString "{rfpendtc}"^^xsd:string
    .

  # SubjectIdentifier
  cdiscpilot01:SubjectIdentifier_{subjid}
      rdf:type study:SubjectIdentifier ;
      skos:prefLabel "{subjid}"^^xsd:string
  .

  # UniqueSubjectIdentifier
  cdiscpilot01:UniqueSubjectIdentifier_{usubjid}
      rdf:type study:UniqueSubjectIdentifier ;
      skos:prefLabel "{usubjid}"^^xsd:string
  .

# -----------------------------------------------------------------------------
# DemographicDataCollection
#   Hard codes:
#     1. VisitScreening1DemogDataColl because DEMOG info was
#       collected at Screening 1 for this study
#     2. code:ActivityStatus_1 : Successful collection of demographics _1 = CO,
#       completed. Assume completed because we have data.
# Person 1 original values:
# ethnicity:   <http://rdf.cdisc.org/sdtmterm#C66790.C17459> ;
# race: <http://rdf.cdisc.org/sdtmterm#C74457.C41261> ;
# sex <http://rdf.cdisc.org/sdtmterm#C66731.C16576>
# Date_19 changed.
#
# VisitScreening1Activity  is further defined in VS_Mappings.TTL
#
# -----------------------------------------------------------------------------
 cdiscpilot01:DemographicDataCollection_{usubjid}
   rdf:type cd01p:VisitScreening1DemogDataColl ;
   rdf:type cdiscpilot01:VisitScreening1Activity_{usubjid} ;
   rdf:type code:DemographicDataCollection ;
   skos:prefLabel "Person {usubjid} Screening 1 Demographic data collection"^^xsd:string ;
   code:hasAge cdiscpilot01:AgeOutcome_{age_en} ;
   study:activityStatus code:ActivityStatus_1 ;
   study:ethnicity code:Enthnicity_{ethnic_en}  ;
   study:hasDate cdiscpilot01:Date_{dmdtc_en} ;
   study:race code:Race_{race_en} ;
   study:sex code:Sex_{sex} ;
 .

   # DemographicDataCollection subtriples
   # VisitScreening1Activity
   cdiscpilot01:VisitScreening1Activity_{usubjid}
     rdf:type owl:Class ;
     rdfs:subClassOf custom:VisitScreening1Activity ;
     skos:prefLabel "Visit Screening 1 Person {usubjid}"^^xsd:string ;
   .

  # WIP validate these triples and the age unit
   # AgeOutcome
   # Previous wascode:hasUnit time:unitYear ;
   cdiscpilot01:AgeOutcome_{age_en}
     rdf:type study:AgeOutcome;
     skos:prefLabel "{age} {ageu}"^^xsd:string ;
     code:hasUnit time:unitYear ;
     code:hasValue "{age}"^^xsd:int ;
   .

   # DemographicDataCollection Date
   cdiscpilot01:Date_{dmdtc_en}
     rdf:type study:DemogDataCollectionDate
   .

 # -----------------------------------------------------------------------------
 # InformedConsent
 #   There is not "informed consent end" in the source data.
 #   Hardcoded: ActivityStatus_1, StartRuleDefault_1, InformedConsentOutcome_1
 # -----------------------------------------------------------------------------
   #InformedConsentAdult
   cdiscpilot01:InformedConsentAdult_{usubjid}
     rdf:type code:InformedConsentAdult ;
     skos:prefLabel "Informed consent Person {usubjid}"^^xsd:string ;
     study:activityStatus code:ActivityStatus_1 ;
     study:hasActivityInterval cdiscpilot01:Interval_{infConsInt_im_en} ;
     study:hasStartRule study:StartRuleDefault_1 ;
     study:outcome code:InformedConsentOutcome_1 ;
   .
     #InformedConsentInterval
     cdiscpilot01:Interval_{infConsInt_im_en} 
       rdf:type study:InformedConsentInterval ;
       rdfs:label "Interval {infConsInt_im}"^^xsd:string ;
       time:hasBeginning cdiscpilot01:Date_{rficdtc_en} ;
     .

     # Date type
     # Informed consent begin is the same time as StudyParticipationBegin
     cdiscpilot01:Date_{rficdtc_en} rdf:type study:InformedConsentBegin
     .
 # -----------------------------------------------------------------------------
 # CumulativeDrugAdministration
 #   Adminstration start and stop are stored in DM. Start to build the parent
 #     triples for the triples later added from EX.
 #  ActivityStatus is hard coded to complete for this data (=xxxx_1)
 # These triples will be created in EX mapping
 #		#  study:hasSubActivity cdiscpilot01:DrugAdministration_1 ;
 #		#  study:hasSubActivity cdiscpilot01:DrugAdministration_2 ;
 #		#  study:hasSubActivity cdiscpilot01:DrugAdministration_3 ;
 #
 # -----------------------------------------------------------------------------
 cdiscpilot01:CumulativeDrugAdministration_{usubjid}
   rdf:type study:CumulativeDrugAdministration ;
   skos:prefLabel "Cumulative Drug Administration {rfxstdtc} - {rfxendtc} "^^xsd:string ;
   study:activityStatus code:ActivityStatus_1 ;
   study:hasActivityInterval cdiscpilot01:Interval_{cumuDrugAdmin_im_en} ;
 .

 cdiscpilot01:Interval_{cumuDrugAdmin_im_en}
   rdf:type           study:CumulativeDrugAdministrationInterval ;
   rdfs:label         "Interval {cumuDrugAdmin_im}"^^xsd:string ;
   time:hasBeginning  cdiscpilot01:Date_{rfxstdtc_en} ;
   time:hasEnd        cdiscpilot01:Date_{rfxendtc_en} ;
 .
  # Assign Date types
  cdiscpilot01:Date_{rfxstdtc_en} 
    rdf:type study:CumulativeDrugAdministrationBegin ;
  .
  cdiscpilot01:Date_{rfxendtc_en} 
     rdf:type study:CumulativeDrugAdministrationEnd ;
  .
 # -----------------------------------------------------------------------------
 # RandomizationBAL3
 #  Randomization type is hard coded.
 #  Activity status hard coded to ActivityStatus_1 complete (CO)
 #  cd01p:ArmPlacebo changed to Arm{armcd}
 cdiscpilot01:RandomizationBAL3_{usubjid}
   rdf:type code:RandomizationBAL3 ;
   skos:prefLabel "Randomization Person {usubjid}"^^xsd:string ;
   study:activityStatus code:ActivityStatus_1 ;
   study:outcome cd01p:Arm{armcd} ;
 .

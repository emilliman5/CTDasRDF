###############################################################################
# FILE: DM_mappings.ttl
# DESC: Stardog SMS Template file for mapping DM to graph.  
# REQ : 
# SRC : 
# IN  : CSV converted from DM.XPT. First row only
# OUT : 
# NOTE: stardog-admin virtual import CTDasRDF DM_mappings.TTL DM_subset.csv
# TODO: 
###############################################################################

@prefix cd01p: <https://raw.githubusercontent.com/phuse-org/CTDasRDF/master/data/rdf/cdiscpilot01-protocol.ttl#> .
@prefix cdiscpilot01: <https://raw.githubusercontent.com/phuse-org/CTDasRDF/master/data/rdf/cdiscpilot01.ttl#> .
@prefix code: <https://raw.githubusercontent.com/phuse-org/CTDasRDF/master/data/rdf/code.ttl#> .
@prefix custom: <https://raw.githubusercontent.com/phuse-org/CTDasRDF/master/data/rdf/custom#> .
@prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> .
@prefix sdtmterm: <http://rdf.cdisc.org/sdtmterm#> .
@prefix skos: <http://www.w3.org/2004/02/skos/core#> .
@prefix study: <https://raw.githubusercontent.com/phuse-org/CTDasRDF/master/data/rdf/study.ttl#> .
@prefix time: <http://www.w3.org/2006/time#> .
@prefix xsd: <http://www.w3.org/2001/XMLSchema#> .


# -----------------------------------------------------------------------------
# Person_
# TODO: build out the DATE triples!! 

# Hash of the USUBJID is used to create unique IRI for each person in the study
cdiscpilot01:Person_{#usubjid} 
  a study:EnrolledSubject;
  skos:preflabel "Person {_ROW_}"^^xsd:string ;
  study:actualArm cd01p:Arm_{#actarm} ;
  study:deathFlag "{dthfl}"^^xsd:string ;
  study:hasLifespan cdiscpilot01:Lifespan_{#brthdate}_{#dthdtc} ;
  study:hasReferenceInterval cdiscpilot01:ReferenceInterval_{#rfstdtc}_{#rfendtc} ;
  study:hasSite cd01p:Site_{#siteid} ;
  study:StudyParticipationInterval cdiscpilot01:StudyParticipationInterval_{#dmdtc}_{#rfpendtc} ;
  study:hasSubjectID cdiscpilot01::SubjectIdentifier_{#subjid} ;
  study:hasUniqueSubjectID cdiscpilot01:UniqueSubjectIdentifier_{#usubjid} ;
  study:participatesIn cdiscpilot01:DemographicDataCollection_{#usubjid};
.

  # Lifespan ----
  #  concat of birthdate and rficdtc hashes.
  cdiscpilot01:Lifespan_{#brthdate}_{#rficdtc} 
    a study:Lifespan ;
    rdfs:label "Lifespan Interval {_ROW_}"^^xsd:string ;
    time:hasBeginning cdiscpilot01:Date_{#brthdate} ;
    time:hasEnd cdiscpilot01:Date_{#rficdtc} 
  .
     
    # Lifespan Dates
    #  a) birthdate
    cdiscpilot01:Date_{#brthdate}
      rdf:type study:Birthdate ;
      rdfs:label "{brthdate}"^^xsd:string ;
      study:dateTimeInXSDString "{brthdate}"^^xsd:string 
    .
    # b) deathdate
    cdiscpilot01:Date_{#dthdtc}
      rdf:type study:Deathdate ;
      rdfs:label "{dthdtc}"^^xsd:string ;
      study:dateTimeInXSDString "{dthdtc}"^^xsd:string 
    .
  
  # ReferenceInterval ----
  cdiscpilot01:ReferenceInterval_{#rfstdtc}_{#rfendtc} 
    a study:ReferenceInterval ;
    rdfs:label "Reference Interval {_ROW_}"^^xsd:string ;
    time:hasBeginning cdiscpilot01:Date_{#rfstdtc} ;
    time:hasEnd cdiscpilot01:Date_{#rfendtc} 
  .
    # ReferenceInterval Dates
    #  a) Begin
    cdiscpilot01:Date_{#rfstdtc}
      rdf:type study:ReferenceBegin ;
      rdfs:label "{rfstdtc}"^^xsd:string ;
      study:dateTimeInXSDString "{rfstdtc}"^^xsd:string 
    .
    #  a) End
    cdiscpilot01:Date_{#rfendtc}
      rdf:type study:ReferenceEnd ;
      rdfs:label "{rfendtc}"^^xsd:string ;
      study:dateTimeInXSDString "{rfendtc}"^^xsd:string 
    .

  # StudyParticipationInterval
  cdiscpilot01:StudyParticipationInterval_{#dmdtc}_{#rfpendtc} 
    rdf:type study:StudyParticipationInterval ;
    rdfs:label "Study Participation Interval {_ROW_}"^^xsd:string ;
    time:hasBeginning cdiscpilot01:Date_{#dmdtc} ;
    time:hasEnd cdiscpilot01:Date_{#rfpendtc} 
  .
    # StudyParticipationInterval Dates
    #  a) Begin
    cdiscpilot01:Date_{#dmdtc} 
      rdf:type study:StudyParticipationBegin ;
      rdfs:label "{dmdtc}"^^xsd:string ;
      study:dateTimeInXSDString "{dmdtc}"^^xsd:string 
    .
    #  b) End
    cdiscpilot01:Date_{#rfpendtc} 
      rdf:type study:StudyParticipationBegin ;
      rdfs:label "{rfpendtc}"^^xsd:string ;
      study:dateTimeInXSDString "{rfpendtc}"^^xsd:string 
    .
 
  # SubjectIdentifier
  cdiscpilot01:SubjectIdentifier_{#subjid} 
      rdf:type study:SubjectIdentifier ;
      skos:prefLabel "{subjid}"^^xsd:string 
  .

  # UniqueSubjectIdentifier
  cdiscpilot01:UniqueSubjectIdentifier_{#usubjid} 
      rdf:type study:UniqueSubjectIdentifier ;
      skos:prefLabel "{usubjid}"^^xsd:string 
  .

# -----------------------------------------------------------------------------
# DemographicDataCollection 
#   Hard codes: 
#     1. VisitScreening1DemogDataColl because DEMOG info was 
#       collected at Screening 1 for this study
#     2. code:ActivityStatus_1 : Successful collection of demographics _1 = CO, 
#       completed. Assume completed because we have data. 
# Person 1 original values:
# ethnicity:   <http://rdf.cdisc.org/sdtmterm#C66790.C17459> ;
# race: <http://rdf.cdisc.org/sdtmterm#C74457.C41261> ;
# sex <http://rdf.cdisc.org/sdtmterm#C66731.C16576>
# Date_19 changed.
# -----------------------------------------------------------------------------
cdiscpilot01:DemographicDataCollection_{#usubjid}
  rdf:type cd01p:VisitScreening1DemogDataColl ;
  rdf:type cdiscpilot01:VisitScreening1Activity_{#usubjid} ;
  rdf:type code:DemographicDataCollection ;
  skos:prefLabel "Person {_ROW_} Screening 1 Demographic data collection"^^xsd:string ;
  code:hasAge cdiscpilot01:AgeOutcome_{#age} ;
  study:activityStatus code:ActivityStatus_1 ;
  study:ethnicity code:Enthnicity_{#ethnic}  ;
  study:hasDate cdiscpilot01:Date_{#dmdtc} ;
  study:race code:Race_{#race} ;
  study:sex code:Sex_{sex} ;
  study:participatesIn cdiscpilot01:InformedConsentAdult_{#usubjid} ;
.

  # DemographicDataCollection subtriples
  # VisitScreening1Activity
  cdiscpilot01:VisitScreening1Activity_{#usubjid}
    rdf:type owl:Class ;
    rdfs:subClassOf custom:VisitScreening1Activity ;
    skos:prefLabel "Visit Screening 1 Person {_ROW_}"^^xsd:string 
  .
  
  # AgeOutcome
  cdiscpilot01:AgeOutcome_{#age} 
    rdf:type study:AgeOutcome;
    skos:prefLabel "{age} {ageu}"^^xsd:string;
    code:hasUnit time:unitYear;
    code:hasValue "{age}"^^xsd:int 
  .
  
#WIP HERE, UNTESTED
  #InformedConsentAdult
  cdiscpilot01:InformedConsentAdult_{#usubjid}
    rdf:type code:InformedConsentAdult ;
    skos:prefLabel "Informed consent Person {_ROW_}"^^xsd:string ;
    study:activityStatus code:ActivityStatus_1 ;
    study:hasActivityInterval cdiscpilot01:InformedConsentInterval_{#usubjid};
    study:hasStartRule study:StartRuleDefault_1 ;
    study:outcome code:InformedConsentOutcome_1 ;

    #xxxxx
    cdiscpilot01:InformedConsentInterval_{#usubjid}
      rdf:type study:InformedConsentInterval ;
      rdfs:label "Informed Consent Interval 1"^^xsd:string ;
      time:hasBeginning cdiscpilot01:Date_{#rficdtc} 
    .
     
    cdiscpilot01:Date_{#rficdtc} rdf:type study:InformedConsentBegin 
    .

  # DemographicDataCollection Date
  cdiscpilot01:Date_{#dmdtc} 
    rdf:type study:DemogDataCollectionDate 
  .
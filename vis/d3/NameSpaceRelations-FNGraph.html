<!DOCTYPE html>
<!-----------------------------------------------------------------------------
FILE: DataRelations-FNGraph.html
DSCR: Network graph of Data Relations in the SDTM Data as RDF Project
SRC :   Based on: (svn) /Phuse/Anual/2016/d3/Attendees-FNGraph.html
INPUT:  /data/DataRelations-FNGraph-test.JSON  - for development
        /data/Attendees-FNGraph-R.JSON , from R,   [TODO!!!]
VIEW  :  http://localhost:8000/SDTMasRDF/vis/d3/NameSpaceRelations-FNGraph.html
REQ  : DataRelations-FNGraph.js, SDTMasRDF.css
NOTES: 
TODO: : Create the R code based on the original from the Annual conference, but with
        Data from this project.

------------------------------------------------------------------------------>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>SDTMasRDF Namespace Relations</title>
    <script type="text/javascript" src="/SDTMasRDF/vis/d3/d3/d3.v3.min.js"></script>
    <link rel="stylesheet" type="text/css" href="/SDTMasRDF/vis/d3/SDTMasRDF.css">
</head>
<body>
<h3>SDTM Data as RDF: Namespace Relations</h3>
<script type="text/javascript">
var w = 1300;  
var h = 900;  

// Factors affecting node display (spread, clustering, etc.)
// Note: Colours set in .CSS
var gravity      = .01
var charge       = -240
var linkDistance = 80
var edgeWidth    = 3
var nodeRadius   = 5  // Size of nodes. Later make this a caculation based on number of nodes in display?

//Width and height for SVG area
var svg = d3.select("body").append("svg")
            .attr("width", w)
            .attr("height", h);

  // Double click to 'unfix' the node and have forces start to act on it again.
  function dblclick(d) {
    d3.select(this).classed("fixed", d.fixed = false);
  }
  // Set the "fixed" property of the dragged node to TRUE when a dragstart event is initiated,
  //   - removes "forces" from acting on that node and changing its position.
  function dragstart(d) {
    d3.select(this).classed("fixed", d.fixed = true);
  }

// Variables for clustering 
var nb_group=3 // divide display into  n regions, 1 for nodeCategory value
var angle = 2*Math.PI/nb_group; // Angle to divide up the display
var intensity = 200; // increase intensity if many groups

// node size scale
var nodeScale = d3.scale.linear()
    .domain([0,180])
    .range([3,20]);

//---- LEGEND  ----------------------------------------------------------------
  svg.append("text")
     .text("Legend")
     .attr("x",28)
     .attr("y",25)
     .attr("class", 'legendTitle'); 
          
  svg.append("rect")
     .attr("x",10)
     .attr("y",35)
     .attr("width",140)
     .attr("height",350)
     .attr("class", 'legendBox');

  var xIndent = 20;       // indent node from left
  var textx = xIndent+8;  // text to the right of the node
  // Move the legend symbols DOWN by increasing yIndent 
  var yIndent = 42;  // start down top.  Add 20 to each observation after the first. (i*20)
  var lineSpace = 30; // space between each line in the legend
  var data = {};

  var tooltip = d3.select("body").append("div")
      .attr("class", "tooltipLegend")
      .style("opacity", 0);
  // Leaving http links in the legend for possible later implementation
   var data = {
    // first "color" value is not read for reasons unknown.
     "nodes": [
         {"title": "CODE",  "foo": "fooVal1", "url": "http%3A%2F%2Fwww.example.org%2Fkmd%2Fcode%2Fphase-POOL"},
         {"title": "STUDY", "foo": "fooVal2", "url": "http%3A%2F%2Fwww.example.org%2Fkmd%2Fcode%2Fphase-PHASE1"},
         {"title": "TIME",  "foo": "fooVal3", "url": "http%3A%2F%2Fwww.example.org%2Fkmd%2Fcode%2Fphase-PHASE2"}
       ],
     "legLine": [
         {"title": "SUBCLASSOF", "descr": "description", "color": "blue", "url": "http%3A%2F%2Fwww.example.org%2Fkmd%2Fcode%2Fcontribtype-EVALUATION"},
         {"title": "EQUIVALENTCLASS", "descr": "description", "color": "blue", "url": "http%3A%2F%2Fwww.example.org%2Fkmd%2Fcode%2Fcontribtype-EVALUATION"},
         {"title": "DOMAIN", "descr": "description", "color": "blue", "url": "http%3A%2F%2Fwww.example.org%2Fkmd%2Fcode%2Fcontribtype-EVALUATION"},
         {"title": "RANGE", "descr": "description", "color": "blue", "url": "http%3A%2F%2Fwww.example.org%2Fkmd%2Fcode%2Fcontribtype-EVALUATION"},
         {"title": "TYPE", "descr": "description", "color": "blue", "url": "http%3A%2F%2Fwww.example.org%2Fkmd%2Fcode%2Fcontribtype-EVALUATION"},
         {"title": "SUBPROPERTYOF", "descr": "description", "color": "blue", "url": "http%3A%2F%2Fwww.example.org%2Fkmd%2Fcode%2Fcontribtype-EVALUATION"},
         {"title": "INVERSEOF", "descr": "description", "color": "blue", "url": "http%3A%2F%2Fwww.example.org%2Fkmd%2Fcode%2Fcontribtype-EVALUATION"}
       ]
     };
  svg.selectAll("legendBox")
      .data(data.nodes)
      .enter()
      .append("rect")
      .attr("width", 60)
      .attr("height", 17)
      .attr("rx", 2) // Round the edge
      .attr("ry", 2) // Round the edge
      .attr("x", xIndent)
      .attr("y", function(d,i){return (yIndent+i*lineSpace)})  // -1 brings the box up
      .attr("class",function(d,i){return (d.title);})   
      .on("click", function (d) {
          if (d3.event.ctrlKey) { location.href = "http://localhost:8890/describe/?uri="+d.url;}
       })
      .on('mouseover', function(d){
          var nodeSelection = d3.select(this).style({opacity:'0.5'});
       })
      //Mouseout Node  - bring node back to full colour   
      .on('mouseout', function(d){
          var nodeSelection= d3.select(this).style({opacity:'1.0',}) 
       })
      ;
   svg.selectAll("boxText")
      .data(data.nodes)
      .enter()
      .append("text")
      .attr("x", textx)
      .attr("y", function(d,i){return ((yIndent+5+i*lineSpace)+7)}) 
      .attr("idBoxText",function(d,i){return 'ID-'+i})
      .attr('class', 'legendNodeText') 
      .text(function(d) {return d.title})
      // same event as for the box, so user may click BOX or text
      .on("click", function (d) {
          if (d3.event.ctrlKey) { location.href = "http://localhost:8890/describe/?uri="+d.url;}
       })
      .on('mouseover', function(d){
          var nodeSelection = d3.select(this).style({opacity:'0.5'});
       })
      //Mouseout Node  - bring node back to full colour   
      .on('mouseout', function(d){
          var nodeSelection= d3.select(this).style({opacity:'1.0',}) 
       })
      ;
 // Lines
  svg.selectAll("legendLine")
      .data(data.legLine)
      .enter()
      .append("line")
      // .attr("x1", xIndent+10)
      .attr("x1", xIndent)
      .attr("y1", function(d,i){return (yIndent+146+i*lineSpace)})
      .attr("x2", 85) // increase for longer line
      .attr("y2", function(d,i){return (yIndent+146+i*lineSpace)})
      //.attr("idLine",function(d,i){return 'IDL-'+i}) // ID needed here to diff from edges in real graph
      .attr("class",function(d,i){return (d.title);})   
      //.style("fill", function(d){return (d.color) })
      //.style("stroke", function(d){return (d.color) })
      //.style("stroke-dasharray", function(d){
      //    if  (d.dashed == "Y" ) {return "5,5"}
      //    else {return "0,0"} })
      .style("stroke-width", 4)
      .on("click", function (d) {
          if (d3.event.ctrlKey) { location.href = "http://localhost:8890/describe/?uri="+d.url;}
       })
      .on('mouseover', function(d){
          var nodeSelection = d3.select(this).style({opacity:'0.5'});
          
       })
      //Mouseout Node  - bring node back to full colour   
      .on('mouseout', function(d){
          var nodeSelection= d3.select(this).style({opacity:'1.0',}) 
        })
      ;
   svg.selectAll("linesText")
      .data(data.legLine)
      .enter()
      .append("text")
      // .attr("x", textx)
       .attr("x", xIndent)
      .attr("y", function(d,i){return ((yIndent+140+i*lineSpace))})   // -2 to align better with circle
      .attr("idLineText",function(d,i){return 'IDLT-'+i})
      .attr('class', 'legendText')
      .text(function(d) {return d.title})
      .on("click", function (d) {
          if (d3.event.ctrlKey) { location.href = "http://localhost:8890/describe/?uri="+d.url;}
       })
      .on('mouseover', function(d){
          var nodeSelection = d3.select(this).style({opacity:'0.5'});
          tooltip.transition()
                 .duration(200)
                 .style("opacity", .9);
                     
           tooltip.html(d.descr)
          //   tooltip.html("TEST TOOL TIP")
                      .style("left", (d3.event.pageX + 5) + "px")
                      .style("top", (d3.event.pageY - 28) + "px");
  
       })
      //Mouseout Node  - bring node back to full colour   
      .on('mouseout', function(d){
          var nodeSelection= d3.select(this).style({opacity:'1.0',}) 
          tooltip.transition()
                 .duration(500)
                 .style("opacity", 0);
       })
      ;

//---- LEGEND END -------------------------------------------------------------

// d3.json("/SDTMasRDF/vis/d3/data/DataRelations-FNGraph-test.JSON", function(dataset) {
 d3.json("/SDTMasRDF/vis/d3/data/NamespaceRelations-FROMR.JSON", function(dataset) {
// d3.json("/SDTMasRDF/vis/d3/data/DataRelations-FNGraph-R.JSON", function(dataset) {
    var force = d3.layout.force()
        .nodes(dataset.nodes)
        .links(dataset.edges)
        .gravity(gravity) 
        .charge(charge)
        .linkDistance(linkDistance)
        .size([w, h])
        .start();
    var drag = force.drag()
        .on("dragstart", dragstart);


 // Build the arrow for RDF Triple
    svg.append("svg:defs").selectAll("marker")
        .data(["end"])      // Different link/path types can be defined here
        .enter().append("svg:marker")    // This section adds in the arrows
        .attr("id", String)
        .attr("viewBox", "0 -5 10 10")
        .attr("refX", 20)  // Increase this number to back the arrow away from the target node
        .attr("refY", 0)
        .attr("markerWidth", 2)  // Arrow height
        .attr("markerHeight", 2) // Arrow width
        .attr("orient", "auto")
        .attr("fill", "black")
        .attr("stroke", "grey")
        .append("svg:path")
        .attr("d", "M0,-5L10,0L0,5");

    // id value - used to identify the edge. Where is it referenced?
    var edges = svg.selectAll("line")
        .data(dataset.edges)
        .enter()
        .append("line")
        .attr("id",function(d,i){return 'edge'+i})
        .attr("stroke-width", edgeWidth)  
        .attr("marker-end", "url(#end)")   //TW TEST. REMOVE?
        .attr("class", function (d) {
            return d.edgeType;
        });
    // Add tooltip mouseover text for Edges (links) 
    edges.append("title")
        .text(function(d) { return d.value });
         
   var nodes = svg.selectAll("g.node")
        .data(dataset.nodes)
        .enter()
        .append("g")
        .attr("class", "node")
        .on("dblclick", dblclick)
        .on("click", function (d) {
          if (d3.event.ctrlKey) { location.href = d.url;}
        })
        .call(drag);

    nodes.append("circle")
        // .attr("r", function(d) { return nodeScale(d.freq); 
        .attr("r", nodeRadius)
        .attr("class", function (d) {
            return d.type;
        })
        // Mousover Node - highlight node by fading the node colour during mouseover
        .on('mouseover', function(d){
            var nodeSelection = d3.select(this).style({opacity:'0.5'});
        })
        //Mouseout Node  - bring node back to full colour   
        .on('mouseout', function(d){
            var nodeSelection= d3.select(this).style({opacity:'1.0',}) 
        })
    // dx sets how close to the node the label appears
    //TW TODO: Move font size and color to CSS STYLE
   // id=nodegroup3  - a separate style for this node type. See #nodegroup3 in CSS section
    nodes.append("text")
        .attr("class", "nodetext")
        .attr("dx",function(d){ 
            if (d.id == 0) {return ""} 
            else {return -15;}
        ;})// offset the text from the node. 
        .attr("dy", "-1.5em") // Offset label fromnode. Move above node with -
        .attr("text-anchor", "middle")  // Center text horizontally
        .text(function(d) { return d.label })            // Just the name

    // Egdge Paths
    //TODO remove stroke and path: are part of CSS now
    var edgepaths = svg.selectAll(".edgepath")
        .data(dataset.edges)
        .enter()
        .append('path')
        .attr({'d': function(d) {return 'M '+d.source.x+' '+d.source.y+' L '+ d.target.x +' '+d.target.y},
            'class':'edgepath',
            'fill-opacity':0,
            'stroke-opacity':0,
            'id':function(d,i) {return 'edgepath'+i}})
        .style("pointer-events", "none");

    force.on("tick", function(e) {
    	  // Position regulator for nodes must update d.x and d.y BEFORE edges are positioned
        nodes.attr("transform", function(d) { 
            d.x += (intensity*Math.cos(angle*(d.nodeCategory)) + w/2 - d.x)*e.alpha;
            d.y += (intensity*Math.sin(angle*(d.nodeCategory)) + h/2 - d.y)*e.alpha;
            return "translate(" + d.x + "," + d.y + ")"; 
        });
        edges.attr("x1", function(d) { return d.source.x; })
            .attr("y1",  function(d) { return d.source.y; })
            .attr("x2",  function(d) { return d.target.x; })
            .attr("y2",  function(d) { return d.target.y; });
      
        edgepaths.attr('d', function(d) { var path='M '+d.source.x+' '+d.source.y+' L '+ d.target.x +' '+d.target.y;
            //console.log(d)
            return path});       

      });  
      
     //TW ADDING ARROWS
         
  });  // end of data read and manip
</script>
</body>
</html>
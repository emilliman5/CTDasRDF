---
title: "CTDasRDF Project Documentation"
output:
  html_document:
    toc: true
    
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction
This document describes the project data files, R scripts, coding conventions, and data modeling decisions for the CTDasRDF project.

**CAUTION: If you are reading this document outside of the R environment, the information is likely out of date! See the .rmd file in the root /CTDasRDF folder for the latest information.**

Information about the PhUSE cloud server environment is contained in separate documentation.


# Data Files
## SDTM Data Sources
Source from the PhUSE CDISCPILOT01 study SDTM files here: https://github.com/phuse-org/phuse-scripts/blob/master/data/sdtm/cdiscpilot01/

Data augmentation for development and testing occurs in files named with xxxx_impute.R, so data created during conversion will not be an exact match with the original .XPT source files.

**DM**, **SUPPDM**,  and **VS** are the initial domains used in the project. This may expand if the project timeline permits.

### Configuration Files
* **prefixes.csv**
    - List of prefixes either currently in use or planned. Includes the prefix name, namespace, and description. Any commas in the description field must have the entire text in quotes.

### RDF Files
* **cdiscpilot01.ttl**
    - Data file containing clinical study results for a subset of patients. As of July 2017, this is the only file created by the R Script conversion of the SDTM domains. 

* **cdiscpilot01-protocol.ttl**
    - Protocol information for the pilot study. Includes arm resources and custom analyses. Protocol-specific items are added to the cdiscpilot01-protocol.ttl file which is customized for each study.  
Later development may include the addition of classes like "Protocol-Specified Activity", "Planned Activity", "Scheduled Activity", "Performed Activity", etc.. They are not currently needed for this project and can be derived as owl:Restriction(s) based on the properties of the Activity. For example, a Protocol Specified Activity is any Defined Activity that is associated with a Start Rule; A Planned Activity, is an instance of a Protocol Specified Activity that is associated with a Subject, ....etc. [Note: This items are also of importance to the PhUSE "Protocol as RDF" project.

* **code.ttl**
    - All standard terms needed for pilot study

* **sdtm.ttl**
    - Mini study ontology in RDF/OWL. Used to generate the SDTM domains in the prototype (currently DM DMSUPP and VS data)

* **study.ttl**
    - Generic study schema, not associated with any particular protocol.study.ttl is the starting point for each new study and contains the items needed to derive the blank case report form and the DEFINE file.

* **sdtm-cdisc01.ttl**
    - Links cdiscpilot01local.ttl with study.ttl for round-tripping the data back to the SDTM standard.

# R Scripts

## R Requirements
The project currently uses Egon Willighagen's R package rrdf <https://github.com/egonw/rrdf> for creating and querying RDF. The package is not available from CRAN. You are not using the PhUSE cloud server you must install and configure your system using these instructions.

## Installation Instructions
Run the following commands from RStudio console

```{r install, eval=FALSE}
install.packages("rJava") # if not present already

install.packages("devtools") # if not present already

library(devtools)
```
If an error occurs, the following additional steps may be needed on some systems:

```{r ifInstallError, eval=FALSE}
library(httr)

set_config(config(ssl_verifypeer = 0L))

install_github("egonw/rrdf", subdir="rrdflibs")

install_github("egonw/rrdf", subdir="rrdf", build_vignettes = FALSE)
```

The package is now available for use from R.


## Installation Troubleshooting

- If the installation fails during installation of rJava, try re-installing your Java JRE.
- Ensure your Java versions match your OS: java -version should display "32-bit" for 32 bit OS, "64-bit" for 64 bit OS.
Additional Notes from J. Ulander for Windows installs:

The command: ```{r ifInstallError, eval=FALSE} install_github("egonw/rrdf", subdir="rrdflibs")``` may result in an error for rJava. A likely cause is the fact that the Java download defaults to the 'bits' of your web browser application, not the Windows OS itself. Eg: On Windows 10 you likely need 64-bit Java for RStudio, but if your browser is 32 bit, you will get the wrong version of Java! To get the correct (in this case, 64-bit) Java version, go here: <https://www.java.co/en/download/manual.jsp> and pick the 64-bit version. Both 32-bit and 64 bit Java should be able to co-exist on the same machine if you need both for other applications.

## Notes on Using the rrdf Package
When using rrdf() to query, the OWL reasoner is turned on by default, as seen here:
<https://github.com/egonw/rrdf/blob/master/rrdf/R/new.rdf.R#L16>

You can turn off the OWL reasoning by:

```{r owlModel, eval=FALSE} 
model <- new.rdf(ontology=FALSE) 
```

  - advice from package creator Egon Willighagen.
  


## R Script Style conventions
* **General**
Use of:
    * dplyr aproaches for code readability and compactness.[CONVERSION IN PROGRESS]. Examples: use of mutate() instead of fooDF$var <- value .
    * apply() functions instead of FOR loops (where practical)
    * Google's R Style Guide <https://google.github.io/styleguide/Rguide.xml> [work in progress]    
      Notable Exceptions:    
          * Functions use Roxygen comment style. From within a Function, in RStudio: Code | Insert Roxygen
          Skeleton
          * Use RStudio comment style for sections to allow navigation
    ```{r sectionComment, eval = F, echo = T}
    # <section name> ----
    ```

    * R Markdown for higher level project documentation.<http://rmarkdown.rstudio.com/> Example: *This document.*
    
## File names designate their function
* **xx_F.R**
    * Functions called by various other scripts. Not run when sourced.

* **xx_impute.R**
    * Create values for the named domain used for development purposes and rule 
    testing. Results in values not present in original source (XPT) data.

* **xx_frag.R**
    * URI fragment creation for the named domain.
    
* **xx_process.R**
    * Triple creation for the named domain. 

# TTL File Creation
## R Script Code Flow
*To properly view this diagram you must use Google Chrome. Copy/Paste the URL into Chrome if the file opens by default into IE or another browser.*

```{r path, eval = T, echo = F}
library(knitr)
read_chunk("r/vis/ProgramFlow-Mermaid.R")
```

```{r processFlow, eval=T, echo = F, fig.height=11, fig.width=10}
```

## File Descriptions  

* **BuildRDF-Driver.R**  
    - Main/Driver program for building the TTL file for the SDTM domains from the CDISCPILOT01 example data. Loads all libraries, sources all .R scripts, writes out TTL.
 
* **graphMeta.R**  
    - Create the RDF Triples for metadata (when triples created, software used, etc.)

* **prefixes.csv**
    - List of namespace prefixes.

* **misc_F.R**
    * Miscellaneous functions include **readXPT()**, **addPersonID()**, **assignDateType()**

* **createFrag_F.R**
    * Functions that create URI "fragments" used to create URIs when building the triples. Includes functions like **createDateDict()**, **addDateFrag()**, **createFragOneDomain()**.

* **DM_impute.R**
Create DM values not in the original source data for testing and development purposes.

* **VS_impute.R**
    * Create VS values not in the original source data for testing and development purposes.

* **DM_frag.R**
    * Create DM fragment values

* **DM_process.R**
    * Create DM triples

* **SUPPDM_impute.R**
    * Create SUPPDM values not in the original source data for testing and development purposes.

* **SUPPDM_process.R**
    * Create SUPPDM triples

* **VS_frag.R**
    * Create VS fragment values

* **VS_process.R**
    * Create VS triples

## Validation
* **CompTriples-Shiny.R**
    * R Shiny App to facilitate c of .TTL file created by TW's R script with the ontology instances created by AO using TopBraid or Protege.

## Visualization
* **Person-MultLevel-VisNetwork-ForceNetwork.R**
    * Triples attached to Person_1 in cdiscpilot01.TTL as a force network graph using visNetwork. Functionality includes: selection by node or group, node selection by mouse click, mouseover of relations.


# Coding Conventions
## Variable naming
* CamelCase for classes
* CamelCase_(n) for instances of classes.

## RDF Namespaces and Prefixes
Prior to import into a triplestore, several of the namespaces correspond to the .TTl files generated from the onotology editor or R scripts. 
**[UNDER DEVELOPMENT]**  
* **cd01p** 

* **cdiscpilot01**

* **code**

* **custom**

* **owl**

* **rdf**

* **rdfs**

* **sdtm**

* **sdtm-terminology**

* **skos**

* **sp**

* **spin**

* **study**

* **time**

* **xsd**


## Data Types
### Dates
Date values are evaluated during the conversion to RDF.

* Date values (as represented in fields like rfstdtc, rfendtc, rfxendtc, etc.) with complete and valid year, month, and data values are typed as xsd:date.
* Incomplete date values or values that have incomplete dateTime values (missing seconds, for example) are typed as xsd:string, since xsd:dateTime would be semantically incorrect. See discussion at: <http://stackoverflow.com/questions/25165456/is-this-a-valid-xsddatetime-if-so-why> At a later time, incomplete date values may be coded to their corresponding components (year,day,hour..) using the TIME ontology. Not currently implemented.



# Data Modeling Decisions    
## Introduction
The traditional SDTM data model is limited by its row x column structure and modeling decisions that can be solved by the RDF ontologies and a multi-dimensional data structure. This section of the project wiki documents the details of the RDF data model and the issues in SDTM that are resolved using Linked Data approaches. Expect this page to change as the model evolves during the project.

"SDTM model" refers to the various approved SDTM versions published by CDISC and "RDF Model" refers to the model under development as part of this project.

## Treatment Arms
SDTM allows "fake" arms, like SCRNFL (screen failure) and NOT TREATED, for valid values for Arm and ArmCD. In the RDF model we treat them as real Arms so we can do the roundtripping back out to SDTM from RDF, but we exclude them from participating as values of Outcomes for "Randomization Activity", since no one is randomized to a screen failure or Not Treated arm.

## Observations
SDTM recognizes three types of Observations:

1. Findings
2. Interventions
3. Events

### Findings and Interventions
In stark contrast to the SDTM Model, the RDF Model defines Findings as a type of Intervention, thus providing a single standard approach to document the process that leads to either a Finding or a therapeutic Intervention. For example, some procedures like cardiac catheterization involve both concepts: a) Finding: determines there is a blocked artery b) (therapuetic) Intervention: inserts a stent to keep artery open

All Findings are Interventions in the sense that "someone has to do something" (that one wouldn't ordinarily do in the course of the subject's daily routine, i.e. to intervene) to make and record the Finding. This is true for simple measures like temperature through to more complex tests like a biopsy. It is often important to document the more complex procedures. For example, to record collection of a biospecimen collection and its processing, and/or the use of a medical device.

### Events
The RDF model defines certain Events like Adverse Events not as Observations, but as Medical Conditions that are identified as an AsessmentOutcome. The SDTM model does not capture the Assessment information that led to the Outcome. In SDTM, assessment information is usually either 1) lumped together with observation data, 2) saved in SUPPQUAL, or 3) relegated to custom domains. The RDF model fixes this modeling problem **[ADD PRECISELY HOW]** while making it challenging to recreate SDTM datasets that perpetuate the modeling error. Automation across submissions may also prove difficult. **[ADD MORE HERE ABOUT THE AUTOMATION ISSUE]**

### Miscellaneous
SDTM variables --CAT and --SCAT have no consistent meaning across submissions and so cannot be modeled consistently in the RDF ontology. This is also true for the entire RELREC domain which relates records with each other **[ADD MORE DETAIL ON CURRENT USE]. In the semantically consistent the RDF model the concept of a record disappears where concepts and data values are related by design.

        
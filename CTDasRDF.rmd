---
title: "CTDasRDF Project Documentation"
output:
  html_document:
    toc: true
    
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Introduction
This document describes the project data files, R scripts, coding conventions, and data modeling decisions for the project.

**CAUTION: If you are reading this document outside of the R environment, the information is likely out of date! 
See the .rmd file in the project's Github root /CTDasRDF folder for the latest information.**

Information about the PhUSE cloud server environment is contained in separate documentation.


# Data Files
## SDTM Data Sources
SDTM XPT data files were obtained from the PhUSE CDISCPILOT01 study: https://github.com/phuse-org/phuse-scripts/blob/master/data/sdtm/cdiscpilot01/

Data augmentation for development and testing occurs in files named with \<domain name\>_impute.R. 
As a result, data files created during conversion will not be an exact match with the original .XPT source files.

**DM**, **SUPPDM**,  and **VS** are the initial domains used in the project. This may expand if the project timeline permits.

### Configuration Files
* **prefixes.csv**
    - List of prefixes either currently in use or planned. Includes the prefix name, namespace, and description. Any commas in the description field must have the entire text in quotes. So in other words, avoiding commas in the description field is a good idea.
 
 
### RDF Files
* **cdiscpilot01.ttl**
    - Data file containing clinical study results for a subset of patients. Instance data is manually added to the .ttl file as needed for testing and development. The file **cdiscpilot01-R.ttl** is created by converting XPT source data. THe two files are comared to ensure the ontology instances match those created by the data conversion process in R. As of July 2017, cdiscpilot01-R.ttl is the only file created by the R Script conversio n of the SDTM domains. 

* **cdiscpilot01-protocol.ttl**
    - Protocol information for the pilot study. Includes arm resources and custom analyses. Protocol-specific items are added to the cdiscpilot01-protocol.ttl file which is customized for each study.  
Later development may include the addition of classes like "Protocol-Specified Activity", "Planned Activity", "Scheduled Activity", "Performed Activity", etc.. They are not currently needed for this project and can be derived as owl:Restriction(s) based on the properties of the Activity. For example, a Protocol Specified Activity is any Defined Activity that is associated with a Start Rule; A Planned Activity, is an instance of a Protocol Specified Activity that is associated with a Subject, ....etc. [Note: These items are also of importance to the PhUSE "Protocol as RDF" project.

* **code.ttl**
    - All standard terms needed for pilot study

* **sdtm.ttl**
    - Mini study ontology in RDF/OWL. Used to generate the SDTM domains in the prototype (currently DM DMSUPP and VS data)

* **study.ttl**
    - Generic study schema, not associated with any particular protocol. study.ttl is the starting point for each new study and contains the items needed to derive the blank case report form and the DEFINE file.

* **sdtm-cdisc01.ttl**
    - Links cdiscpilot01.ttl with study.ttl for round-tripping the data back to the SDTM standard.

# R Scripts

## R Requirements
In September 2017 the project switched from use of  Egon Willighagen's R package rrdf <https://github.com/egonw/rrdf> to the redland package <https://cran.r-project.org/web/packages/redland/> .
This change removes dependencies on rJava and provides a data conversion mechanism that relies on a package available from CRAN.

## R Script Style conventions
* **General**

Use of:
    * dplyr aproaches for code readability and compactness.[CONVERSION IN PROGRESS]. Examples: use of mutate() instead of fooDF$var <- value .
    * apply() functions instead of FOR loops (where practical)
    * Google's R Style Guide <https://google.github.io/styleguide/Rguide.xml> [work in progress]    
      Notable Exceptions:    
          * Functions use Roxygen comment style. From within a Function, in RStudio: Code | Insert Roxygen
          Skeleton
          * Use RStudio comment style for sections to allow navigation
    ```{r sectionComment, eval = F, echo = T}
    # <section name> ----
    ```

    * R Markdown for higher level project documentation.<http://rmarkdown.rstudio.com/> Example: *This document.*
    
## File names designate their function
* **xx_F.R**
    * Functions called by various other scripts. Not run when sourced.

* **xx_impute.R**
    * Create values for the named domain used for development purposes and rule 
    testing. Results in values not present in original source (XPT) data.

* **xx_frag.R**
    * URI fragment creation for the named domain.
    
* **xx_process.R**
    * Triple creation for the named domain. 

# TTL File Creation
## R Script Code Flow
*To properly view this diagram you must use Google Chrome. Copy/Paste the URL into Chrome if the file opens by default into IE or another browser.*

```{r path, eval = T, echo = F}
library(knitr)
read_chunk("r/vis/ProgramFlow-Mermaid.R")
```

```{r processFlow, eval=T, echo = F, fig.height=11, fig.width=10}
```

## File Descriptions  

* **BuildRDF-Driver.R**  
    - Main/Driver program for building the TTL file for the SDTM domains from the CDISCPILOT01 example data. Loads all libraries, sources all .R scripts, writes out TTL.
 
* **graphMeta.R**  
    - Create the RDF Triples for metadata (when triples created, software used, etc.)

* **prefixes.csv**
    - List of namespace prefixes.

* **misc_F.R**
    * Miscellaneous functions include **readXPT()**, **addPersonID()**, **assignDateType()**

* **createFrag_F.R**
    * Functions that create URI "fragments" used to create URIs when building the triples. Includes functions like **createDateDict()**, **addDateFrag()**, **createFragOneDomain()**.

* **DM_impute.R**
Create DM values not in the original source data for testing and development purposes.

* **VS_impute.R**
    * Create VS values not in the original source data for testing and development purposes.

* **DM_frag.R**
    * Create DM fragment values

* **DM_process.R**
    * Create DM triples

* **SUPPDM_impute.R**
    * Create SUPPDM values not in the original source data for testing and development purposes.

* **SUPPDM_process.R**
    * Create SUPPDM triples

* **VS_frag.R**
    * Create VS fragment values

* **VS_process.R**
    * Create VS triples

## Validation
* **CompTriples-Shiny.R**
    * R Shiny App to facilitate comparison of the .TTL file created by TW's R script with the ontology instances created by AO using TopBraid or Protege.

## Visualization
* **Person-MultLevel-VisNetwork-ForceNetwork.R**
    * Triples attached to Person_1 in cdiscpilot01.TTL as a force network graph using visNetwork. Functionality includes: selection by node or group, node selection by mouse click, mouseover of relations.

# Coding Conventions
## Variable naming
* CamelCase for classes
* CamelCase_(n) for instances of classes.

## RDF Namespaces and Prefixes
Prior to import into a triplestore, several of the namespaces correspond to the .TTL files generated from the onotology editor or R scripts. 
**[SECTION UNDER DEVELOPMENT]**  
* **cd01p** 

* **cdiscpilot01**

* **code**

* **custom**

* **owl**

* **rdf**

* **rdfs**

* **sdtm**

* **sdtm-terminology**

* **skos**

* **sp**

* **spin**

* **study**

* **time**

* **xsd**


## Data Types
### Dates and Date Processing
Date values are evaluated during the conversion to RDF.

* Date values (as represented in fields like rfstdtc, rfendtc, rfxendtc, etc.) with complete and valid year, month, and data values are typed as xsd:date.
* Incomplete date values or values that have incomplete dateTime values (missing seconds, for example) are typed as xsd:string, since xsd:dateTime would be semantically incorrect. See discussion at: <http://stackoverflow.com/questions/25165456/is-this-a-valid-xsddatetime-if-so-why> At a later time, incomplete date values may be coded to their corresponding components (year,day,hour..) using the TIME ontology (not currently implemented).

Dates are assigned a URI by first combining all dates (during dev, only a subset!) from the domains being processed (DM, SUPPDM, VS, EX) into a single column, sorting by date, then assigning a number. This is accomplished in the function createDateDict() within createFrag_F.R. It is called from buildRDF-Driver.R after the domains have been imported from the XPT. To add new domains and date columns you must edit createDateDict().

After the list of all dates and their URIs is created, the date URI's must be merged back into the individual domains. This is accomplished using addDateFrag(), called from <domain>_Frag.R , one call for each date column. TODO: Make the assignments back to the respective domains within createDateDic(), removing the need to call addDateFrag.



# Data Modeling Decisions    
## Introduction
The traditional SDTM data model is limited by its row x column structure and modeling decisions that can be solved by the RDF ontologies and a multi-dimensional data structure. This section of the project wiki documents the details of the RDF data model and the issues in SDTM that are resolved using Linked Data approaches. Expect this page to change as the model evolves during the project.

"SDTM model" refers to the various approved SDTM versions published by CDISC and "RDF Model" refers to the model under development as part of this project.

## Treatment Arms
SDTM allows "fake" arms, like SCRNFL (screen failure) and NOT TREATED, for valid values for Arm and ArmCD. In the RDF model we treat them as real Arms so we can do the roundtripping back out to SDTM from RDF, but we exclude them from participating as values of Outcomes for "Randomization Activity", since no one is randomized to a screen failure or Not Treated arm.

## Observations
SDTM recognizes three types of Observations:

1. Findings
2. Interventions
3. Events

### Findings and Interventions
In stark contrast to the SDTM Model, the RDF Model defines Findings as a type of Intervention, thus providing a single standard approach to document the process that leads to either a Finding or a therapeutic Intervention. For example, some procedures like cardiac catheterization involve both concepts: a) Finding: determines there is a blocked artery b) (therapuetic) Intervention: inserts a stent to keep artery open

All Findings are Interventions in the sense that "someone has to do something" (that one wouldn't ordinarily do in the course of the subject's daily routine, i.e. to intervene) to make and record the Finding. This is true for simple measures like temperature through to more complex tests like a biopsy. It is often important to document the more complex procedures. For example, to record collection of a biospecimen collection and its processing, and/or the use of a medical device.

### Events
The RDF model defines certain Events like Adverse Events not as Observations, but as Medical Conditions that are identified as an AsessmentOutcome. The SDTM model does not capture the Assessment information that led to the Outcome. In SDTM, assessment information is usually either 1) lumped together with observation data, 2) saved in SUPPQUAL, or 3) relegated to custom domains. The RDF model fixes this modeling problem **[TODO: ADD PRECISELY HOW]** while making it challenging to recreate SDTM datasets that perpetuate the modeling error. Automation across submissions may also prove difficult. **[TODO: ADD MORE HERE ABOUT THE AUTOMATION ISSUE]**

### VS : Body Position and test sequence [2017-10-24]
Each subject has two AssumeBodyPosition activities, 1 lying and 1 standing

Sequence:

1. After lying 5 minutes:        SBP1, DBP1, Pulse1
2. Stand. After standing 1 min:  SBP2, DBP2, Pulse2
3. Still standing: after 3 min:  SBP3, DBP3, Pulse3
 
Both standing activities are associated with the same standing "event" : AssumeBodyPositionStanding_(n).  The person stands (assumes standing position), then the two start rules come into play: StartRuleStanding1_(n)  (1 minute stand rule),  followed later by StartRuleStanding3_(n)  (3 minute standing rule).

This sequence is not explicit in the SDTM data. It is derived by a combination of the USUBJID, VISIT, and VSPTNUM fields during triple creation.

### Miscellaneous
SDTM variables --CAT and --SCAT have no consistent meaning across submissions and so cannot be modeled consistently in the RDF ontology. This is also true for the entire RELREC domain which relates records with each other **[TODO:ADD MORE DETAIL ON CURRENT USE]**. In the semantically consistent the RDF model the concept of a record disappears where concepts and data values are related by design.

        